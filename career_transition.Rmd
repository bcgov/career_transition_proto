---
title: "Career Transition Tool"
output: flexdashboard::flex_dashboard
runtime: shiny
resource_files:
- processed_data/cip_noc_top5.csv
- processed_data/job_openings.csv
- processed_data/wages.csv
- processed_data/scaled_characteristics_noc.csv
---

```{r}
library(tidyverse)
library(vroom)
library(here)
#functions-----------------------
teer_table <- function(noc){
  teer_description%>%
    filter(teer==str_sub(noc,2,2))%>%
    select("{noc}":= description)%>%
    DT::datatable(rownames = FALSE, options = list(dom="t"))
}
make_plot <- function(tbbl){
  temp <- tbbl%>%
    group_by(category)%>% 
    mutate(all_category=fct_reorder(all_category, `Need for improvement`, .desc = TRUE))
 
  ggplot(temp, aes(all_category,
                  `Need for improvement`,
                  fill=category,
                  text=subcategory))+
    geom_col()+
    labs(y="Need for improvement",
         x="",
         fill="")+
    scale_y_continuous(limits = c(0, 6), labels = NULL)+
    scale_x_discrete(labels  = NULL) +
    scale_fill_brewer(palette = "Dark2")+
    theme_minimal()
}

make_plotly <- function(plt){ 
  plotly::ggplotly(plt, tooltip = "text")%>% 
    plotly::config(displayModeBar = F)
}
wage_plot <- function(num){
  wages%>%
    filter(noc %in% c(input$noc, difference()$noc[num]))%>%
    ggplot(mapping = aes(y=noc, 
                         x = median_wage,
                         text=paste("The typical hourly wage is", 
                                    scales::dollar(median_wage),
                                    "but can be as low as",
                                    scales::dollar(low_wage),
                                    "or as high as",
                                    scales::dollar(high_wage),
                                     "for <br>",
                                    str_sub(noc,8,-1)
                                    ))) +
    geom_pointrange(mapping = aes(xmin = low_wage, xmax = high_wage))+
    scale_x_continuous(labels=scales::dollar)+
    labs(y="", 
         x="Hourly Wage Rate")+
    theme_minimal()+ 
    theme(text = element_text(size = 12))
}
jo_plot <- function(num){
  job_openings%>%
    filter(noc %in% c(input$noc, difference()$noc[num]))%>%
    group_by(noc)%>%
    mutate(sum_jo=sum(job_openings))%>%
    ggplot(mapping = aes(year, 
                         job_openings, 
                         colour=noc,
                         text=paste0("Total projected job openings (",
                                    first_year,
                                    " to ",
                                    last_year,
                                    ") are ",
                                    scales::comma(sum_jo),
                                    " for <br>",
                                    str_sub(noc,8,-1)
                                    ))) +
    geom_line()+
    theme_minimal()+
    theme(legend.position='none')+
    labs(y="",
         x="",
         colour="")+ 
    theme(text = element_text(size = 17))
}

fos_table <- function(num){
  origin <- cip_noc_top5%>%
  filter(noc ==input$noc)%>%
  ungroup()%>%
  select(`Field of Study`)%>%
  pull()

destination <- cip_noc_top5%>%
  filter(noc == difference()$noc[num])%>%
  ungroup()%>%
  select(`Field of Study`)%>%
  pull()

tibble("{input$noc}":=origin,
       "{difference()$noc[num]}":=destination)%>%
  DT::datatable(rownames = FALSE, options=list(dom='t'))
}

#load the data, do the PCA
teer_description <- read_csv(here("processed_data","teer_description.csv"))
cip_noc_top5 <- read_csv(here("processed_data","cip_noc_top5.csv"))
wages <- vroom(here("processed_data","wages.csv"))
job_openings <- vroom(here("processed_data","job_openings.csv"))
first_year <- min(job_openings$year)
last_year <- max(job_openings$year)
tbbl <- vroom(here("processed_data","scaled_characteristics_noc.csv"))%>%
  column_to_rownames(var="noc")
pca <- prcomp(tbbl)
first_pca <- pca[["x"]][,1:5]%>% #keep only the first 5 principal components.
    as.data.frame()
```

Sidebar {.sidebar}
=====================================

* Choosing an origin occupation in the first dropdown box populates the second dropdown box with ten closest destination occupations.
* Closeness is based on 161 attributes from 4 categories:
    - Abilities
    - Knowledge
    - Skills
    - Work activities 

```{r}
selectInput(
  "noc",
  "Choose an origin occupation:",
  rownames(tbbl),
  selected = "41401: Economists and economic policy researchers and analysts",
  multiple = FALSE
)
```

```{r}
#reactive elements----------------
q <- reactive({
  first_pca[rownames(first_pca)==input$noc,] #the location of the chosen NOC in 10D space.
})
temp <- reactive({
  dbscan::kNN(first_pca, k = 11, sort=TRUE,  query = q()) #11 nearest neighbors to query (own NOC included)
})
nn <-  reactive({
  rownames(first_pca)[as.vector(temp()[["id"]])] #the names of the closest occupations
})
chosen_noc <- reactive({
  tbbl[rownames(tbbl)==input$noc,] #the skill profile of the chosen NOC (35D)
})
repeated_chosen <- reactive({
  chosen_noc()[rep(1, 11), ] #replicate the skill profile of the chosen NOC
})
closest <- reactive({
  tbbl[rownames(tbbl) %in% nn(), ] #the nearest neighbour NOCs to the chosen NOC
})
wrong_order_difference <- reactive({
  (closest()-repeated_chosen())%>% #the difference in skills
  mutate(across(everything(), \(x) round(x, 2)))%>%
  rownames_to_column(var="noc")%>%
  pivot_longer(cols=-noc, names_to = "all_category", values_to = "Need for improvement")%>%
  mutate(temp=all_category)%>%
  separate(temp, into = c("category","subcategory"), sep=": ")%>%
  filter(noc!=input$noc)%>%
  group_by(noc, category)%>%
  slice_max(order_by = `Need for improvement`, n = 5, with_ties=FALSE)%>%
  group_by(noc)%>%
  nest()%>%
  mutate(plot=map(data, make_plot),
         plotly=map(plot, make_plotly)
         )
})
#order the dataframe correctly------------
difference <- reactive({
  wrong_order_difference()[match(nn(), wrong_order_difference()$noc), ]%>%
  na.omit()
})
#the pages--------------
```


`r renderUI({paste0(word(str_split_1(difference()$noc[[1]], ":")[2],2),"...")})`
=====================================  

Column 
-------------------------------------
    
### **`r renderUI({str_split_1(difference()$noc[[1]], ":")[2]})`**
    

```{r}
plotly::renderPlotly({
  difference()[["plotly"]][[1]]
}) 
```

### Training, education, experience and responsibilities

```{r}
DT::renderDT({
  teer_table(input$noc)
})
```

### Training, education, experience and responsibilities

```{r}
DT::renderDT({
  teer_table(difference()$noc[1])
})
```

   
Column 
-------------------------------------
   
### Comparison of Hourly Wage Rates.

```{r, fig.retina=3}
plotly::renderPlotly({
  make_plotly(wage_plot(1))
})
```   
 
### LMO Projected Job Openings for years `r first_year` to `r last_year`.
    
```{r, fig.retina=3}
plotly::renderPlotly({
  make_plotly(jo_plot(1))
})
```

### Top fields of study: % of workers with background

```{r}
DT::renderDT({
  fos_table(1)
})

```
